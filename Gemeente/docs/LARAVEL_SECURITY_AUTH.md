# Laravel Security & Authentication - Gemeente Portal

## üìã Inhoudsopgave

1. [Authentication System](#authentication-system)
2. [Authorization & Policies](#authorization--policies)
3. [CSRF Protection](#csrf-protection)
4. [XSS Prevention](#xss-prevention)
5. [SQL Injection Protection](#sql-injection-protection)
6. [Session Security](#session-security)
7. [Password Security](#password-security)
8. [File Upload Security](#file-upload-security)

---

## üîê Authentication System

### Laravel Breeze Setup

```bash
# Install Breeze
composer require laravel/breeze --dev
php artisan breeze:install blade
php artisan migrate
npm install && npm run build
```

### Authentication Routes

```php
<?php
// routes/auth.php (generated by Breeze)

use App\Http\Controllers\Auth\AuthenticatedSessionController;
use App\Http\Controllers\Auth\RegisteredUserController;
use App\Http\Controllers\Auth\PasswordResetLinkController;
use Illuminate\Support\Facades\Route;

Route::middleware('guest')->group(function () {
    // Registration
    Route::get('register', [RegisteredUserController::class, 'create'])
                ->name('register');
    Route::post('register', [RegisteredUserController::class, 'store']);

    // Login
    Route::get('login', [AuthenticatedSessionController::class, 'create'])
                ->name('login');
    Route::post('login', [AuthenticatedSessionController::class, 'store']);

    // Password Reset
    Route::get('forgot-password', [PasswordResetLinkController::class, 'create'])
                ->name('password.request');
    Route::post('forgot-password', [PasswordResetLinkController::class, 'store'])
                ->name('password.email');
});

Route::middleware('auth')->group(function () {
    // Logout
    Route::post('logout', [AuthenticatedSessionController::class, 'destroy'])
                ->name('logout');
});
```

### Login Controller

```php
<?php
// app/Http/Controllers/Auth/AuthenticatedSessionController.php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use App\Http\Requests\Auth\LoginRequest;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class AuthenticatedSessionController extends Controller
{
    /**
     * Display the login view.
     */
    public function create()
    {
        return view('auth.login');
    }

    /**
     * Handle an incoming authentication request.
     */
    public function store(LoginRequest $request)
    {
        // Validate + authenticate
        $request->authenticate();

        // Regenerate session (prevent session fixation)
        $request->session()->regenerate();

        // Redirect to intended page or dashboard
        return redirect()->intended(route('dashboard'));
    }

    /**
     * Destroy an authenticated session.
     */
    public function destroy(Request $request)
    {
        // Logout user
        Auth::guard('web')->logout();

        // Invalidate session
        $request->session()->invalidate();

        // Regenerate CSRF token
        $request->session()->regenerateToken();

        return redirect('/');
    }
}
```

### Login Request Validation

```php
<?php
// app/Http/Requests/Auth/LoginRequest.php

namespace App\Http\Requests\Auth;

use Illuminate\Auth\Events\Lockout;
use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\RateLimiter;
use Illuminate\Validation\ValidationException;

class LoginRequest extends FormRequest
{
    /**
     * Validation rules.
     */
    public function rules(): array
    {
        return [
            'email' => ['required', 'string', 'email'],
            'password' => ['required', 'string'],
        ];
    }

    /**
     * Attempt to authenticate the request's credentials.
     */
    public function authenticate(): void
    {
        // Rate limiting check
        $this->ensureIsNotRateLimited();

        // Attempt login
        if (! Auth::attempt($this->only('email', 'password'), $this->boolean('remember'))) {
            // Increment failed attempts
            RateLimiter::hit($this->throttleKey());

            throw ValidationException::withMessages([
                'email' => trans('auth.failed'),
            ]);
        }

        // Clear rate limit on success
        RateLimiter::clear($this->throttleKey());
    }

    /**
     * Ensure the login request is not rate limited.
     */
    public function ensureIsNotRateLimited(): void
    {
        if (! RateLimiter::tooManyAttempts($this->throttleKey(), 5)) {
            return;
        }

        event(new Lockout($this));

        $seconds = RateLimiter::availableIn($this->throttleKey());

        throw ValidationException::withMessages([
            'email' => trans('auth.throttle', [
                'seconds' => $seconds,
                'minutes' => ceil($seconds / 60),
            ]),
        ]);
    }

    /**
     * Get the rate limiting throttle key for the request.
     */
    public function throttleKey(): string
    {
        return strtolower($this->input('email')).'|'.$this->ip();
    }
}
```

### Login View

```blade
{{-- resources/views/auth/login.blade.php --}}

<x-guest-layout>
    <!-- Session Status -->
    <x-auth-session-status class="mb-4" :status="session('status')" />

    <form method="POST" action="{{ route('login') }}">
        @csrf

        <!-- Email Address -->
        <div>
            <x-input-label for="email" :value="__('Email')" />
            <x-text-input id="email" 
                          class="block mt-1 w-full" 
                          type="email" 
                          name="email" 
                          :value="old('email')" 
                          required 
                          autofocus 
                          autocomplete="username" />
            <x-input-error :messages="$errors->get('email')" class="mt-2" />
        </div>

        <!-- Password -->
        <div class="mt-4">
            <x-input-label for="password" :value="__('Password')" />
            <x-text-input id="password" 
                          class="block mt-1 w-full"
                          type="password"
                          name="password"
                          required 
                          autocomplete="current-password" />
            <x-input-error :messages="$errors->get('password')" class="mt-2" />
        </div>

        <!-- Remember Me -->
        <div class="block mt-4">
            <label for="remember_me" class="inline-flex items-center">
                <input id="remember_me" 
                       type="checkbox" 
                       name="remember"
                       class="rounded border-gray-300">
                <span class="ml-2 text-sm text-gray-600">{{ __('Remember me') }}</span>
            </label>
        </div>

        <div class="flex items-center justify-end mt-4">
            @if (Route::has('password.request'))
                <a class="underline text-sm" href="{{ route('password.request') }}">
                    {{ __('Forgot your password?') }}
                </a>
            @endif

            <x-primary-button class="ml-3">
                {{ __('Log in') }}
            </x-primary-button>
        </div>
    </form>
</x-guest-layout>
```

### Auth Middleware

```php
<?php
// app/Http/Middleware/Authenticate.php

namespace App\Http\Middleware;

use Illuminate\Auth\Middleware\Authenticate as Middleware;

class Authenticate extends Middleware
{
    /**
     * Get the path the user should be redirected to when not authenticated.
     */
    protected function redirectTo($request): ?string
    {
        return $request->expectsJson() 
            ? null 
            : route('login');
    }
}
```

### Using Auth in Controllers

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Support\Facades\Auth;

class ComplaintController extends Controller
{
    public function __construct()
    {
        // Protect all methods
        $this->middleware('auth');
        
        // Or protect specific methods
        $this->middleware('auth')->only(['store', 'update']);
        $this->middleware('auth')->except(['index', 'show']);
    }
    
    public function index()
    {
        // Get authenticated user
        $user = Auth::user();
        $user = auth()->user(); // Helper
        $user = request()->user(); // Via request
        
        // Check if authenticated
        if (Auth::check()) {
            // User is logged in
        }
        
        // Get user ID
        $userId = Auth::id();
        
        // User's complaints
        $complaints = $user->complaints;
    }
}
```

### Auth Helpers in Blade

```blade
@auth
    {{-- User is logged in --}}
    <p>Welcome, {{ auth()->user()->name }}!</p>
@endauth

@guest
    {{-- User is guest --}}
    <a href="{{ route('login') }}">Login</a>
@endguest

{{-- Check specific guard --}}
@auth('admin')
    {{-- Admin is logged in --}}
@endauth

{{-- Get user --}}
{{ Auth::user()->name }}
{{ auth()->user()->email }}
```

---

## üõ°Ô∏è Authorization & Policies

### Spatie Laravel Permission

```bash
# Install package
composer require spatie/laravel-permission
php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider"
php artisan migrate
```

### Config

```php
<?php
// config/permission.php

return [
    'models' => [
        'permission' => Spatie\Permission\Models\Permission::class,
        'role' => Spatie\Permission\Models\Role::class,
    ],

    'table_names' => [
        'roles' => 'roles',
        'permissions' => 'permissions',
        'model_has_permissions' => 'model_has_permissions',
        'model_has_roles' => 'model_has_roles',
        'role_has_permissions' => 'role_has_permissions',
    ],

    'cache' => [
        'expiration_time' => DateInterval::createFromDateString('24 hours'),
        'key' => 'spatie.permission.cache',
    ],
];
```

### User Model Setup

```php
<?php
// app/Models/User.php

namespace App\Models;

use Illuminate\Foundation\Auth\User as Authenticatable;
use Spatie\Permission\Traits\HasRoles;

class User extends Authenticatable
{
    use HasRoles;
    
    // Guard name (default: web)
    protected $guard_name = 'web';
}
```

### Creating Roles & Permissions

```php
<?php
// database/seeders/RolePermissionSeeder.php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Spatie\Permission\Models\Role;
use Spatie\Permission\Models\Permission;

class RolePermissionSeeder extends Seeder
{
    public function run(): void
    {
        // Reset cached roles and permissions
        app()[\Spatie\Permission\PermissionRegistrar::class]->forgetCachedPermissions();

        // Create permissions
        $permissions = [
            'view-complaints',
            'create-complaints',
            'edit-complaints',
            'delete-complaints',
            'manage-users',
        ];

        foreach ($permissions as $permission) {
            Permission::create(['name' => $permission]);
        }

        // Create roles and assign permissions
        $userRole = Role::create(['name' => 'user']);
        $userRole->givePermissionTo(['view-complaints', 'create-complaints']);

        $adminRole = Role::create(['name' => 'admin']);
        $adminRole->givePermissionTo(Permission::all());

        // Assign role to user
        $admin = User::where('email', 'admin@gemeente.nl')->first();
        $admin->assignRole('admin');
    }
}
```

### Assigning Roles

```php
// Assign role
$user->assignRole('admin');
$user->assignRole('admin', 'editor');
$user->assignRole(['admin', 'editor']);

// Remove role
$user->removeRole('admin');

// Sync roles (replace all)
$user->syncRoles(['admin']);

// Check roles
$user->hasRole('admin'); // true/false
$user->hasAnyRole(['admin', 'editor']); // Has at least one
$user->hasAllRoles(['admin', 'editor']); // Has all

// Get roles
$user->getRoleNames(); // Collection of role names
```

### Assigning Permissions

```php
// Assign permission
$user->givePermissionTo('edit-complaints');
$role->givePermissionTo('edit-complaints');

// Revoke permission
$user->revokePermissionTo('edit-complaints');

// Sync permissions
$user->syncPermissions(['edit-complaints', 'delete-complaints']);

// Check permissions
$user->hasPermissionTo('edit-complaints');
$user->can('edit-complaints'); // Laravel's built-in

// Get permissions
$user->getAllPermissions(); // Direct + via roles
$user->getDirectPermissions(); // Only direct
$user->getPermissionsViaRoles(); // Only via roles
```

### Middleware

```php
<?php
// routes/admin.php

use Illuminate\Support\Facades\Route;

Route::middleware(['auth', 'role:admin'])->group(function () {
    Route::get('/admin/dashboard', [DashboardController::class, 'index']);
});

// Multiple roles (OR)
Route::middleware(['auth', 'role:admin|moderator'])->group(function () {
    // ...
});

// Permission middleware
Route::middleware(['auth', 'permission:edit-complaints'])->group(function () {
    // ...
});

// Multiple permissions
Route::middleware(['auth', 'permission:edit-complaints|delete-complaints'])->group(function () {
    // ...
});
```

### Blade Directives

```blade
@role('admin')
    {{-- User has admin role --}}
    <a href="/admin">Admin Panel</a>
@endrole

@hasrole('admin')
    {{-- Same as @role --}}
@endhasrole

@hasanyrole('admin|moderator')
    {{-- User has admin OR moderator --}}
@endhasanyrole

@hasallroles('admin|moderator')
    {{-- User has admin AND moderator --}}
@endhasallroles

@can('edit-complaints')
    {{-- User has permission --}}
    <button>Edit</button>
@endcan

@cannot('edit-complaints')
    {{-- User doesn't have permission --}}
    <p>You cannot edit complaints</p>
@endcannot
```

### Authorization in Controllers

```php
<?php

namespace App\Http\Controllers\Admin;

use App\Models\Complaint;

class ComplaintAdminController extends Controller
{
    public function __construct()
    {
        // Require admin role
        $this->middleware('role:admin');
    }
    
    public function edit(Complaint $complaint)
    {
        // Check permission
        if (! auth()->user()->can('edit-complaints')) {
            abort(403, 'Unauthorized');
        }
        
        // Or use authorize()
        $this->authorize('update', $complaint);
        
        return view('admin.complaints.edit', compact('complaint'));
    }
    
    public function update(Request $request, Complaint $complaint)
    {
        // Check role
        if (! auth()->user()->hasRole('admin')) {
            return back()->with('error', 'Unauthorized');
        }
        
        $complaint->update($request->validated());
        
        return redirect()->route('admin.complaints.index');
    }
}
```

### Policy (Advanced Authorization)

```bash
# Generate policy
php artisan make:policy ComplaintPolicy --model=Complaint
```

```php
<?php
// app/Policies/ComplaintPolicy.php

namespace App\Policies;

use App\Models\Complaint;
use App\Models\User;

class ComplaintPolicy
{
    /**
     * Determine if the given complaint can be viewed by the user.
     */
    public function view(User $user, Complaint $complaint): bool
    {
        // Admins can view all
        if ($user->hasRole('admin')) {
            return true;
        }
        
        // Users can view their own
        return $user->id === $complaint->user_id;
    }

    /**
     * Determine if the given complaint can be updated by the user.
     */
    public function update(User $user, Complaint $complaint): bool
    {
        // Only admins can update
        return $user->hasRole('admin');
    }

    /**
     * Determine if the given complaint can be deleted by the user.
     */
    public function delete(User $user, Complaint $complaint): bool
    {
        // Only admins can delete
        return $user->hasRole('admin');
    }
}
```

```php
// Register policy in AuthServiceProvider
protected $policies = [
    Complaint::class => ComplaintPolicy::class,
];

// Use in controller
$this->authorize('update', $complaint);

// Use in Blade
@can('update', $complaint)
    <button>Edit</button>
@endcan
```

---

## üîí CSRF Protection

### Wat is CSRF?

Cross-Site Request Forgery - een aanval waarbij kwaadaardige requests namens een gebruiker worden gestuurd.

**Voorbeeld aanval zonder CSRF protection:**
```html
<!-- Kwaadaardige website evil.com -->
<img src="https://gemeente.test/complaints/123/delete">
<!-- Als gebruiker is ingelogd op gemeente.test, wordt complaint verwijderd! -->
```

### Laravel CSRF Protection

```php
<?php
// app/Http/Kernel.php

protected $middlewareGroups = [
    'web' => [
        \App\Http\Middleware\VerifyCsrfToken::class,
        // ...
    ],
];
```

### CSRF Token in Forms

```blade
{{-- Method 1: @csrf directive --}}
<form method="POST" action="/complaints">
    @csrf
    {{-- Generates: <input type="hidden" name="_token" value="..."> --}}
    
    <input type="text" name="title">
    <button type="submit">Submit</button>
</form>

{{-- Method 2: Hidden input --}}
<form method="POST" action="/complaints">
    <input type="hidden" name="_token" value="{{ csrf_token() }}">
    <!-- ... -->
</form>
```

### CSRF in AJAX

```javascript
// Method 1: Meta tag in layout
<meta name="csrf-token" content="{{ csrf_token() }}">

// JavaScript
fetch('/api/complaints', {
    method: 'POST',
    headers: {
        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content,
        'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
});

// Method 2: Axios (auto includes CSRF)
axios.post('/complaints', data);
```

### Excluding Routes from CSRF

```php
<?php
// app/Http/Middleware/VerifyCsrfToken.php

class VerifyCsrfToken extends Middleware
{
    /**
     * URIs that should be excluded from CSRF verification.
     */
    protected $except = [
        'api/*',
        'webhooks/*',
    ];
}
```

---

## üõ°Ô∏è XSS Prevention

### Wat is XSS?

Cross-Site Scripting - injecteren van kwaadaardige scripts in webpagina's.

**Voorbeeld aanval:**
```php
// User input
$name = "<script>alert('XSS!')</script>";

// Zonder escaping (DANGEROUS!)
echo $name; // Script wordt uitgevoerd!
```

### Blade Escaping (Automatic)

```blade
{{-- Auto-escaped (SAFE) --}}
{{ $complaint->title }}
{{-- Output: &lt;script&gt;alert('XSS')&lt;/script&gt; --}}

{{-- Raw output (DANGEROUS!) --}}
{!! $complaint->title !!}
{{-- Output: <script>alert('XSS')</script> --}}

{{-- Only use {!! !!} voor trusted HTML --}}
{!! $trustedHtmlContent !!}
```

### Manual Escaping

```php
// In PHP
$safe = htmlspecialchars($userInput, ENT_QUOTES, 'UTF-8');

// Laravel helper
$safe = e($userInput);

// In Blade
{{ e($userInput) }}
```

### Sanitizing User Input

```php
<?php
// app/Http/Requests/StoreComplaintRequest.php

use Illuminate\Support\Str;

class StoreComplaintRequest extends FormRequest
{
    protected function prepareForValidation()
    {
        $this->merge([
            // Strip tags
            'title' => strip_tags($this->title),
            
            // Remove HTML
            'description' => Str::of($this->description)
                ->stripTags()
                ->trim()
                ->toString(),
        ]);
    }
}
```

### Content Security Policy (CSP)

```php
<?php
// app/Http/Middleware/AddSecurityHeaders.php

namespace App\Http\Middleware;

use Closure;

class AddSecurityHeaders
{
    public function handle($request, Closure $next)
    {
        $response = $next($request);
        
        // Prevent inline scripts
        $response->headers->set('Content-Security-Policy', 
            "default-src 'self'; " .
            "script-src 'self' 'unsafe-inline' https://unpkg.com; " .
            "style-src 'self' 'unsafe-inline';"
        );
        
        // Prevent clickjacking
        $response->headers->set('X-Frame-Options', 'SAMEORIGIN');
        
        // XSS protection
        $response->headers->set('X-XSS-Protection', '1; mode=block');
        
        // Content type sniffing
        $response->headers->set('X-Content-Type-Options', 'nosniff');
        
        return $response;
    }
}
```

---

## üíâ SQL Injection Protection

### Wat is SQL Injection?

Het injecteren van kwaadaardige SQL code via user input.

**Voorbeeld aanval:**
```php
// DANGEROUS - Raw SQL met concatenation
$email = $request->input('email'); // "'; DROP TABLE users; --"
$sql = "SELECT * FROM users WHERE email = '$email'";
DB::select($sql);
// Result: SELECT * FROM users WHERE email = ''; DROP TABLE users; --'
```

### Eloquent ORM (Automatic Protection)

```php
// ‚úÖ SAFE - Eloquent uses prepared statements
User::where('email', $email)->first();
// Generates: SELECT * FROM users WHERE email = ? (binds: [$email])

Complaint::where('id', $id)->delete();
// Parameter is automatically escaped
```

### Query Builder with Bindings

```php
// ‚úÖ SAFE - Parameter binding
DB::select('SELECT * FROM complaints WHERE status = ?', [$status]);

// Named bindings
DB::select('SELECT * FROM complaints WHERE status = :status', [
    'status' => $status
]);

// Multiple parameters
DB::select('SELECT * FROM complaints WHERE status = ? AND priority = ?', [
    $status, 
    $priority
]);
```

### whereRaw with Bindings

```php
// ‚úÖ SAFE - With parameter binding
Complaint::whereRaw('DATE(created_at) = ?', [now()->toDateString()])->get();

// ‚ùå DANGEROUS - Without bindings
Complaint::whereRaw("DATE(created_at) = '$date'")->get();
```

### LIKE Queries

```php
// ‚úÖ SAFE - Eloquent escapes
Complaint::where('title', 'like', '%' . $search . '%')->get();

// ‚úÖ SAFE - With binding
DB::select('SELECT * FROM complaints WHERE title LIKE ?', ['%' . $search . '%']);
```

### Mass Assignment Protection

```php
<?php
// app/Models/Complaint.php

class Complaint extends Model
{
    // Whitelist
    protected $fillable = [
        'title',
        'description',
        'status',
    ];
    
    // Or blacklist
    protected $guarded = [
        'id',
        'created_at',
        'updated_at',
    ];
}

// Without protection:
Complaint::create($request->all()); // ‚Üê User could inject 'id', 'created_at', etc.

// With protection:
Complaint::create($request->validated()); // ‚Üê Only validated fields
```

---

## üîë Session Security

### Session Configuration

```php
<?php
// config/session.php

return [
    // Session driver
    'driver' => env('SESSION_DRIVER', 'file'),
    // Options: file, cookie, database, apc, memcached, redis, dynamodb, array

    // Session lifetime (minutes)
    'lifetime' => 120,

    // Expire on close
    'expire_on_close' => false,

    // Encrypt session data
    'encrypt' => false,

    // Session files location
    'files' => storage_path('framework/sessions'),

    // Session cookie name
    'cookie' => env(
        'SESSION_COOKIE',
        Str::slug(env('APP_NAME', 'laravel'), '_').'_session'
    ),

    // Cookie path
    'path' => '/',

    // Cookie domain
    'domain' => env('SESSION_DOMAIN'),

    // HTTPS only
    'secure' => env('SESSION_SECURE_COOKIE', false),

    // HTTP only (prevent JavaScript access)
    'http_only' => true,

    // SameSite attribute
    'same_site' => 'lax', // lax, strict, none, or null
];
```

### Session Fixation Prevention

```php
// Regenerate session ID on login
public function store(LoginRequest $request)
{
    $request->authenticate();
    
    // Regenerate session ID (prevent fixation)
    $request->session()->regenerate();
    
    return redirect()->intended('/dashboard');
}

// Manual regeneration
session()->regenerate();
```

### Session Usage

```php
// Store data
session(['key' => 'value']);
session()->put('key', 'value');

// Retrieve data
$value = session('key');
$value = session()->get('key', 'default');

// Check if exists
if (session()->has('key')) {
    //
}

// Remove data
session()->forget('key');

// Flash data (available only on next request)
session()->flash('success', 'Complaint created!');

// Retrieve and delete
$value = session()->pull('key');

// Clear all session data
session()->flush();
```

---

## üîê Password Security

### Password Hashing

```php
use Illuminate\Support\Facades\Hash;

// Hash password
$hashedPassword = Hash::make('password123');
// Uses bcrypt with cost 10 by default

// Custom cost
$hashedPassword = Hash::make('password123', [
    'rounds' => 12,
]);

// Verify password
if (Hash::check('password123', $hashedPassword)) {
    // Password matches
}

// Check if needs rehash (if cost changed)
if (Hash::needsRehash($hashedPassword)) {
    $hashedPassword = Hash::make('password123');
}
```

### Password Validation Rules

```php
<?php
// app/Http/Requests/Auth/RegisterRequest.php

use Illuminate\Validation\Rules\Password;

class RegisterRequest extends FormRequest
{
    public function rules(): array
    {
        return [
            'email' => ['required', 'string', 'email', 'max:255', 'unique:users'],
            
            // Simple
            'password' => ['required', 'confirmed', 'min:8'],
            
            // Or with Password rule
            'password' => ['required', 'confirmed', Password::min(8)],
            
            // Complex requirements
            'password' => [
                'required',
                'confirmed',
                Password::min(8)
                    ->letters()       // At least one letter
                    ->mixedCase()     // Uppercase + lowercase
                    ->numbers()       // At least one number
                    ->symbols()       // At least one symbol
                    ->uncompromised() // Check against data breaches
            ],
        ];
    }
}
```

### Password Reset

```php
<?php
// app/Http/Controllers/Auth/PasswordResetLinkController.php

use Illuminate\Support\Facades\Password;

class PasswordResetLinkController extends Controller
{
    public function store(Request $request)
    {
        $request->validate(['email' => 'required|email']);

        // Send password reset link
        $status = Password::sendResetLink(
            $request->only('email')
        );

        return $status === Password::RESET_LINK_SENT
            ? back()->with('status', __($status))
            : back()->withErrors(['email' => __($status)]);
    }
}
```

---

## üìÅ File Upload Security

### Upload Validation

```php
<?php
// app/Http/Requests/StoreComplaintRequest.php

class StoreComplaintRequest extends FormRequest
{
    public function rules(): array
    {
        return [
            'attachments' => ['nullable', 'array', 'max:5'],
            'attachments.*' => [
                'file',
                'max:10240', // 10MB
                'mimes:jpg,jpeg,png,pdf',
                'dimensions:min_width=100,min_height=100,max_width=4000,max_height=4000',
            ],
        ];
    }
}
```

### Secure File Storage

```php
<?php
// app/Http/Controllers/ComplaintController.php

public function store(StoreComplaintRequest $request)
{
    $complaint = Complaint::create($validated);
    
    if ($request->hasFile('attachments')) {
        foreach ($request->file('attachments') as $file) {
            // Generate unique filename
            $filename = Str::uuid() . '.' . $file->getClientOriginalExtension();
            
            // Store with sanitized name
            $path = $file->storeAs(
                "complaints/{$complaint->id}",
                $filename,
                'public'
            );
            
            // Save to database
            $complaint->attachments()->create([
                'filename' => $filename,
                'original_name' => $file->getClientOriginalName(),
                'path' => $path,
                'mime_type' => $file->getMimeType(),
                'size' => $file->getSize(),
            ]);
        }
    }
    
    return redirect()->route('complaints.show', $complaint);
}
```

### File Download

```php
public function download(ComplaintImage $attachment)
{
    // Check authorization
    $this->authorize('view', $attachment->complaint);
    
    // Serve file
    return Storage::disk('public')->download(
        $attachment->path,
        $attachment->original_name
    );
}

// Or inline display
public function show(ComplaintImage $attachment)
{
    $this->authorize('view', $attachment->complaint);
    
    return Storage::disk('public')->response($attachment->path);
}
```

### File Type Validation

```php
// Validate by MIME type (not extension!)
'file' => 'mimes:jpg,jpeg,png,pdf',

// Or by MIME type
'file' => 'mimetypes:image/jpeg,image/png,application/pdf',

// Image specific
'file' => 'image', // Must be image
'file' => 'image|max:5000', // Image, max 5MB

// Document specific
'file' => 'mimes:pdf,doc,docx',
```

---

## üéØ Security Best Practices Samenvatting

### ‚úÖ DO's
1. **Always use CSRF tokens** - In all POST/PUT/DELETE forms
2. **Escape output** - Use `{{ }}` not `{!! !!}`
3. **Use Eloquent ORM** - Prevents SQL injection
4. **Hash passwords** - Use `Hash::make()`
5. **Validate file uploads** - Check MIME type, size, dimensions
6. **Regenerate session on login** - Prevent session fixation
7. **Use HTTPS** - Set `SESSION_SECURE_COOKIE=true`
8. **Rate limit authentication** - Prevent brute force
9. **Sanitize user input** - Strip tags, validate
10. **Use policies** - Authorization logic in dedicated classes

### ‚ùå DON'Ts
1. **Raw SQL without bindings** - SQL injection risk
2. **Plain text passwords** - Always hash
3. **Trust user input** - Always validate
4. **Allow unlimited uploads** - Set max size/count
5. **Expose sensitive data** - Use `.env` for secrets
6. **Skip authorization checks** - Verify user permissions
7. **Disable CSRF protection** - Keep it enabled
8. **Use weak password requirements** - Enforce complexity
9. **Store files in public/** - Use `storage/app/public/`
10. **Forget to rate limit** - Prevent abuse

---

**Next:** [Testing & Debugging](LARAVEL_TESTING.md)
